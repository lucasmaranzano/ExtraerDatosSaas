<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAAS â€” Centro de Descargas Â· Ãrea 4</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg:      #0d0f14;
    --surface: #141720;
    --surface2:#1a1e2e;
    --border:  #252a38;
    --accent:  #4fffb0;
    --accent2: #ff6b6b;
    --accent3: #93c5fd;
    --yellow:  #fbbf24;
    --text:    #e8ecf0;
    --muted:   #6b7280;
    --mono:    'IBM Plex Mono', monospace;
    --sans:    'IBM Plex Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem 3rem;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(79,255,176,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(79,255,176,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { width: 100%; max-width: 680px; position: relative; z-index: 1; }

  /* â”€â”€ HEADER â”€â”€ */
  header { margin-bottom: 2rem; }
  .badge {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--accent);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    border: 1px solid var(--accent);
    display: inline-block;
    padding: 0.2rem 0.6rem;
    margin-bottom: 0.75rem;
  }
  h1 { font-size: 2rem; font-weight: 300; letter-spacing: -0.02em; line-height: 1.2; }
  h1 span { color: var(--accent); font-weight: 600; }
  .subtitle { font-family: var(--mono); font-size: 0.72rem; color: var(--muted); margin-top: 0.4rem; }

  /* â”€â”€ MODE SELECTOR â”€â”€ */
  .mode-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border: 1px solid var(--border);
    margin-bottom: 1rem;
    overflow: hidden;
  }
  .mode-btn {
    background: var(--surface);
    border: none;
    color: var(--muted);
    font-family: var(--mono);
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.85rem 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    border-right: 1px solid var(--border);
  }
  .mode-btn:last-child { border-right: none; }
  .mode-btn .mode-icon { font-size: 1.2rem; }
  .mode-btn.active { background: rgba(79,255,176,0.08); color: var(--accent); border-bottom: 2px solid var(--accent); }
  .mode-btn:hover:not(.active) { color: var(--text); background: var(--surface2); }

  /* â”€â”€ CARDS â”€â”€ */
  .card { background: var(--surface); border: 1px solid var(--border); padding: 1.25rem 1.5rem; margin-bottom: 0.75rem; }
  .card-label {
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    display: block;
    margin-bottom: 0.5rem;
  }

  /* â”€â”€ TOKEN â”€â”€ */
  .token-status { font-family: var(--mono); font-size: 0.67rem; margin-bottom: 0.45rem; min-height: 0.9rem; }
  .token-status.saved   { color: var(--accent); }
  .token-status.unsaved { color: var(--yellow); }

  input[type="password"], input[type="text"], input[type="date"], textarea, select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.65rem 0.85rem;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
    -webkit-appearance: none;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--accent); }
  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234fffb0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.8rem center;
    padding-right: 2rem;
    cursor: pointer;
  }
  select option { background: #1a1e2e; color: var(--text); }

  .btn-row { display: flex; gap: 0.5rem; margin-top: 0.6rem; flex-wrap: wrap; }
  .btn-sm {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: var(--mono);
    font-size: 0.67rem;
    padding: 0.3rem 0.7rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ WEBAPP URL â”€â”€ */
  .webapp-row { display: flex; gap: 0.5rem; align-items: stretch; margin-top: 0.5rem; }
  .webapp-row input { flex: 1; }
  .webapp-status {
    font-family: var(--mono);
    font-size: 0.67rem;
    margin-top: 0.4rem;
    min-height: 0.9rem;
  }
  .webapp-status.ok  { color: var(--accent); }
  .webapp-status.err { color: var(--accent2); }
  .webapp-status.warn { color: var(--yellow); }

  /* â”€â”€ OS GRID â”€â”€ */
  .os-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-top: 0.5rem; }
  .os-item {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.45rem 0.7rem;
    border: 1px solid var(--border);
    background: var(--bg);
    cursor: pointer; transition: all 0.15s;
    font-size: 0.78rem; user-select: none;
  }
  .os-item:hover { border-color: var(--accent); }
  .os-item.active { border-color: var(--accent); background: rgba(79,255,176,0.05); }
  .os-item.active .dot { background: var(--accent); }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); flex-shrink: 0; transition: background 0.15s; }

  /* â”€â”€ DATE ROW â”€â”€ */
  .date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.5rem; }
  input[type="date"] { color-scheme: dark; }

  /* â”€â”€ PANEL â”€â”€ */
  .panel { display: none; }
  .panel.active { display: block; }

  /* â”€â”€ AÃ‘OS â”€â”€ */
  .years-grid { display: flex; gap: 0.4rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .year-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: var(--mono);
    font-size: 0.72rem;
    padding: 0.35rem 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .year-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(79,255,176,0.06); }
  .year-btn:hover:not(.active) { border-color: var(--text); color: var(--text); }

  /* â”€â”€ CHECKBOX â”€â”€ */
  .checkbox-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.6rem; }
  .checkbox-row input[type="checkbox"] { width: auto; accent-color: var(--accent); cursor: pointer; }
  .checkbox-label { font-family: var(--mono); font-size: 0.7rem; color: var(--muted); cursor: pointer; }

  /* â”€â”€ ACTION BUTTONS â”€â”€ */
  .action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.25rem; }

  .btn-download {
    width: 100%;
    background: var(--accent);
    color: #0d0f14;
    border: none;
    font-family: var(--mono);
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 0.9rem 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-download:hover { background: #3de89a; }
  .btn-download:disabled { background: var(--muted); cursor: not-allowed; opacity: 0.6; }
  .btn-download .btn-inner { display: flex; align-items: center; justify-content: center; gap: 0.4rem; }

  .btn-sheets {
    width: 100%;
    background: none;
    border: 1px solid #34a853;
    color: #34a853;
    font-family: var(--mono);
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 0.9rem 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-sheets:hover { background: rgba(52,168,83,0.1); }
  .btn-sheets:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-sheets .btn-inner { display: flex; align-items: center; justify-content: center; gap: 0.4rem; }

  .btn-cancel {
    width: 100%;
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.6rem;
    cursor: pointer;
    margin-top: 0.4rem;
    transition: all 0.2s;
    display: none;
  }
  .btn-cancel.visible { display: block; }
  .btn-cancel:hover { border-color: var(--accent2); color: var(--accent2); }

  /* â”€â”€ PROGRESS â”€â”€ */
  .progress-wrap { display: none; margin-top: 1rem; }
  .progress-wrap.visible { display: block; }
  .progress-bar-bg { background: var(--border); height: 3px; width: 100%; overflow: hidden; margin-bottom: 0.75rem; }
  .progress-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; }

  .log {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--muted);
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border);
    background: var(--bg);
    padding: 0.75rem;
  }
  .log-line { line-height: 1.8; border-bottom: 1px solid rgba(255,255,255,0.03); }
  .log-line.ok   { color: var(--accent); }
  .log-line.err  { color: var(--accent2); }
  .log-line.info { color: var(--accent3); }
  .log-line.warn { color: var(--yellow); }

  .result-ok {
    display: none;
    margin-top: 0.75rem;
    border: 1px solid var(--accent);
    padding: 0.85rem 1.1rem;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--accent);
    background: rgba(79,255,176,0.05);
    line-height: 1.6;
  }
  .result-ok.visible { display: block; }

  /* â”€â”€ MODAL TOKEN â”€â”€ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.78); z-index: 100;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal-box {
    background: var(--surface);
    border: 1px solid var(--accent);
    padding: 1.5rem; width: 90%; max-width: 480px;
    display: flex; flex-direction: column; gap: 0.75rem;
    position: relative; z-index: 101;
  }
  .modal-title {
    font-family: var(--mono); font-size: 0.78rem;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--accent);
    border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;
  }
  .modal-steps { display: flex; flex-direction: column; gap: 0.4rem; }
  .step { font-size: 0.78rem; color: var(--muted); display: flex; gap: 0.6rem; align-items: flex-start; line-height: 1.5; }
  .step b { color: var(--text); }
  .step code { background: rgba(79,255,176,0.1); color: var(--accent); padding: 0 0.3rem; font-family: var(--mono); font-size: 0.68rem; }
  .step-num { background: var(--accent); color: #0d0f14; font-family: var(--mono); font-weight: 600; font-size: 0.6rem; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .btn-open-site { background: none; border: 1px solid var(--accent); color: var(--accent); font-family: var(--mono); font-size: 0.73rem; padding: 0.45rem 0.9rem; cursor: pointer; transition: all 0.2s; align-self: flex-start; }
  .btn-open-site:hover { background: rgba(79,255,176,0.1); }
  .modal-box textarea { resize: vertical; min-height: 80px; }
  .modal-actions { display: flex; gap: 0.5rem; }
  .btn-modal-ok { flex: 1; background: var(--accent); color: #0d0f14; border: none; font-family: var(--mono); font-weight: 600; font-size: 0.75rem; padding: 0.6rem; cursor: pointer; }
  .btn-modal-ok:hover { background: #3de89a; }
  .btn-modal-cancel { background: none; border: 1px solid var(--border); color: var(--muted); font-family: var(--mono); font-size: 0.75rem; padding: 0.6rem 1rem; cursor: pointer; }
  .btn-modal-cancel:hover { border-color: var(--accent2); color: var(--accent2); }

  footer { margin-top: 2rem; font-family: var(--mono); font-size: 0.63rem; color: var(--muted); text-align: center; }
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <header>
    <div class="badge">SAAS Â· Ãrea 4 Â· IntegraciÃ³n</div>
    <h1>Centro de<br><span>Descargas</span></h1>
    <p class="subtitle">// gLiquidacionAreaId=4 Â· Token Bearer requerido</p>
  </header>

  <!-- TOKEN CARD -->
  <div class="card">
    <span class="card-label">Bearer Token</span>
    <div class="token-status" id="tokenStatus"></div>
    <input type="password" id="bearerInput" placeholder="eyJhbGciOi..." oninput="onTokenInput()" />
    <div class="btn-row">
      <button class="btn-sm" onclick="toggleVis()">ğŸ‘ Mostrar / Ocultar</button>
      <button class="btn-sm" onclick="guardarToken()">ğŸ’¾ Guardar token</button>
      <button class="btn-sm" onclick="abrirPopupToken()">ğŸŒ Obtener del sitio</button>
    </div>
  </div>

  <!-- GOOGLE SHEETS CARD -->
  <div class="card">
    <span class="card-label">Google Sheets â€” Web App URL</span>
    <div class="webapp-row">
      <input type="text" id="webappUrl" placeholder="https://script.google.com/macros/s/.../exec" oninput="onWebappInput()" />
      <button class="btn-sm" onclick="guardarWebapp()" style="white-space:nowrap;">ğŸ’¾ Guardar</button>
      <button class="btn-sm" onclick="testWebapp()" style="white-space:nowrap;">ğŸ”— Test</button>
    </div>
    <div class="webapp-status" id="webappStatus">â€” PegÃ¡ la URL del Web App de Apps Script</div>
    <div style="font-family:var(--mono);font-size:0.63rem;color:var(--muted);margin-top:0.5rem;">
      Â¿No tenÃ©s la URL? DescargÃ¡ el archivo <strong style="color:var(--accent3)">GoogleAppsScript.js</strong> e instalalo en tu Sheet (instrucciones incluidas).
    </div>
  </div>

  <!-- MODE SELECTOR -->
  <div class="mode-selector">
    <button class="mode-btn active" id="modeBtn0" onclick="setMode(0)">
      <span class="mode-icon">ğŸ“Š</span>
      <span>Comprobantes Subidos</span>
      <span style="font-size:0.6rem;opacity:.6;">Excel â†’ Sheets</span>
    </button>
    <button class="mode-btn" id="modeBtn1" onclick="setMode(1)">
      <span class="mode-icon">ğŸ“‹</span>
      <span>Pedido IntegraciÃ³n SSS</span>
      <span style="font-size:0.6rem;opacity:.6;">CSV â†’ Sheets</span>
    </button>
  </div>

  <!-- â”€â”€ PANEL 0: COMPROBANTES EXCEL â”€â”€ -->
  <div class="panel active" id="panel0">

    <div class="card">
      <span class="card-label">Obras Sociales</span>
      <div class="os-grid" id="osGridExcel"></div>
    </div>

    <div class="card">
      <span class="card-label">Rango de fechas</span>
      <div class="date-row">
        <div>
          <span class="card-label">Desde</span>
          <input type="date" id="dateFrom" />
        </div>
        <div>
          <span class="card-label">Hasta</span>
          <input type="date" id="dateTo" />
        </div>
      </div>
    </div>

    <div class="action-group">
      <button class="btn-download" id="btnExcel" onclick="iniciarDescargaExcel(false)">
        <div class="btn-inner"><span>â–¼</span><span>Descargar Excel</span></div>
      </button>
      <button class="btn-sheets" id="btnExcelSheets" onclick="iniciarDescargaExcel(true)">
        <div class="btn-inner"><span>â¬†</span><span>Enviar a Sheets</span></div>
      </button>
    </div>
    <button class="btn-cancel" id="cancelExcel" onclick="cancelarExcel()">âœ• Cancelar</button>

  </div>

  <!-- â”€â”€ PANEL 1: PEDIDOS CSV â”€â”€ -->
  <div class="panel" id="panel1">

    <div class="card">
      <span class="card-label">Obras Sociales</span>
      <div class="os-grid" id="osGridCsv"></div>
    </div>

    <div class="card">
      <span class="card-label">AÃ±os a incluir</span>
      <div class="years-grid" id="yearsGrid"></div>
    </div>

    <div class="card">
      <span class="card-label">Tipo de pedido</span>
      <select id="tipoSelect">
        <option value="aceptados">Aceptados</option>
        <option value="rechazados">Rechazados</option>
        <option value="noaceptados">No Aceptados Ni Rechazados</option>
      </select>
      <div class="checkbox-row" style="margin-top:0.75rem;">
        <input type="checkbox" id="modoPrueba" />
        <label class="checkbox-label" for="modoPrueba">Modo prueba (1 obra, 1 perÃ­odo)</label>
      </div>
    </div>

    <div class="action-group">
      <button class="btn-download" id="btnCsv" onclick="iniciarDescargaCsv(false)">
        <div class="btn-inner"><span>â–¼</span><span>Descargar CSV</span></div>
      </button>
      <button class="btn-sheets" id="btnCsvSheets" onclick="iniciarDescargaCsv(true)">
        <div class="btn-inner"><span>â¬†</span><span>Enviar a Sheets</span></div>
      </button>
    </div>
    <button class="btn-cancel" id="cancelCsv" onclick="cancelarCsv()">âœ• Cancelar</button>

  </div>

  <!-- SHARED PROGRESS -->
  <div class="progress-wrap" id="progressWrap">
    <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
    <div class="log" id="logBox"></div>
  </div>
  <div class="result-ok" id="resultOk"></div>

  <footer>gLiquidacionAreaId=4 Â· CORS required Â· localStorage persistence</footer>
</div>

<!-- MODAL TOKEN -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-title">Obtener Bearer Token</div>
    <div class="modal-steps">
      <div class="step"><span class="step-num">1</span>Se abrirÃ¡ <b>coberturasalud.saas.com.ar</b> en una nueva ventana</div>
      <div class="step"><span class="step-num">2</span>IniciÃ¡ sesiÃ³n si hace falta</div>
      <div class="step"><span class="step-num">3</span>AbrÃ­ DevTools â†’ Application â†’ Local Storage â†’ clave <code>Credentials</code></div>
      <div class="step"><span class="step-num">4</span>CopiÃ¡ el valor del campo <code>token</code> y pegalo abajo</div>
    </div>
    <button class="btn-open-site" onclick="window.open('https://coberturasalud.saas.com.ar','_blank')">Abrir sitio â†’</button>
    <span class="card-label" style="margin-top:0.5rem;">PegÃ¡ el token o el JSON completo de Credentials:</span>
    <textarea id="modalTokenInput" placeholder='eyJhbGciOi...  Ã³  {"token":"eyJ..."}'></textarea>
    <div class="modal-actions">
      <button class="btn-modal-ok" onclick="usarTokenDelModal()">Usar este token</button>
      <button class="btn-modal-cancel" onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OBRAS = [
  {nombre:"Cobertura de Salud", base:"https://coberturasalud.client-api.saas.com.ar"},
  {nombre:"OSMISS",             base:"https://osmiss.client-api.saas.com.ar"},
  {nombre:"OSEN",               base:"https://osen.client-api.saas.com.ar"},
  {nombre:"VIALIDAD",           base:"https://ostv.client-api.saas.com.ar"},
  {nombre:"OSSIMRA",            base:"https://ossimra.client-api.saas.com.ar"},
  {nombre:"OSCONARA",           base:"https://osconara.client-api.saas.com.ar"},
];
const G_LIQ_AREA_ID = 4;
const LS_TOKEN_KEY  = 'comprobantes_bearer_token';
const LS_WEBAPP_KEY = 'saas_webapp_url';
const CURRENT_YEAR  = new Date().getFullYear();
const YEARS_DISPLAY = [CURRENT_YEAR - 1, CURRENT_YEAR];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selExcel   = new Set(OBRAS.map((_,i)=>i));
let selCsv     = new Set(OBRAS.map((_,i)=>i));
let selYears   = new Set(YEARS_DISPLAY);
let cancelFlag = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  buildOsGrid('osGridExcel', selExcel);
  buildOsGrid('osGridCsv',   selCsv);
  buildYearsGrid();
  setDateDefaults();
  cargarTokenGuardado();
  cargarWebappGuardada();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(idx){
  [0,1].forEach(i=>{
    document.getElementById(`panel${i}`).classList.toggle('active',i===idx);
    document.getElementById(`modeBtn${i}`).classList.toggle('active',i===idx);
  });
  resetUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OS GRIDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildOsGrid(containerId, selSet){
  const grid=document.getElementById(containerId);
  OBRAS.forEach((os,i)=>{
    const el=document.createElement('div');
    el.className='os-item active';
    el.innerHTML=`<div class="dot"></div><span>${os.nombre}</span>`;
    el.onclick=()=>{
      if(selSet.has(i)){ selSet.delete(i); el.classList.remove('active'); }
      else             { selSet.add(i);    el.classList.add('active'); }
    };
    grid.appendChild(el);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  YEARS GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildYearsGrid(){
  const grid=document.getElementById('yearsGrid');
  YEARS_DISPLAY.forEach(y=>{
    const btn=document.createElement('button');
    btn.className='year-btn active';
    btn.textContent=y;
    btn.onclick=()=>{
      if(selYears.has(y)){ selYears.delete(y); btn.classList.remove('active'); }
      else               { selYears.add(y);    btn.classList.add('active'); }
    };
    grid.appendChild(btn);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FECHAS DEFAULT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setDateDefaults(){
  const pad=n=>String(n).padStart(2,'0');
  const hoy=new Date(), desde=new Date(hoy);
  desde.setMonth(desde.getMonth()-6);
  const fmt=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  document.getElementById('dateFrom').value=fmt(desde);
  document.getElementById('dateTo').value=fmt(hoy);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOKEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cargarTokenGuardado(){
  try {
    const s=localStorage.getItem(LS_TOKEN_KEY);
    if(s){ document.getElementById('bearerInput').value=s; setTokenStatus('saved','âœ“ Token guardado cargado'); }
    else { setTokenStatus('unsaved','â€” Sin token guardado'); }
  }catch(e){}
}
function guardarToken(){
  const t=document.getElementById('bearerInput').value.trim();
  if(!t){ alert('No hay token para guardar.'); return; }
  try{ localStorage.setItem(LS_TOKEN_KEY,t); setTokenStatus('saved','âœ“ Token guardado'); }catch(e){}
}
function setTokenStatus(tipo,msg){
  const el=document.getElementById('tokenStatus');
  el.textContent=msg; el.className=`token-status ${tipo}`;
}
function onTokenInput(){
  const v=document.getElementById('bearerInput').value.trim();
  try{
    const s=localStorage.getItem(LS_TOKEN_KEY);
    if(!v) setTokenStatus('unsaved','â€” Sin token');
    else if(s&&v===s) setTokenStatus('saved','âœ“ Coincide con el guardado');
    else setTokenStatus('unsaved','âš  Token modificado â€” no guardado');
  }catch(e){}
}
function toggleVis(){
  const i=document.getElementById('bearerInput');
  i.type=i.type==='password'?'text':'password';
}
function abrirPopupToken(){ document.getElementById('modalOverlay').classList.add('open'); document.getElementById('modalTokenInput').value=''; }
function cerrarModal(){ document.getElementById('modalOverlay').classList.remove('open'); }
function usarTokenDelModal(){
  const raw=document.getElementById('modalTokenInput').value.trim();
  if(!raw){ alert('PegÃ¡ el token primero.'); return; }
  let token=raw;
  try{
    const obj=JSON.parse(raw);
    if(obj.token) token=obj.token;
    else if(obj.value){ const inner=JSON.parse(obj.value); if(inner.token) token=inner.token; }
  }catch(e){}
  document.getElementById('bearerInput').value=token;
  try{ localStorage.setItem(LS_TOKEN_KEY,token); }catch(e){}
  setTokenStatus('saved','âœ“ Token guardado');
  cerrarModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEBAPP URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cargarWebappGuardada(){
  try{
    const u=localStorage.getItem(LS_WEBAPP_KEY);
    if(u){ document.getElementById('webappUrl').value=u; setWebappStatus('ok','âœ“ URL guardada cargada'); }
  }catch(e){}
}
function guardarWebapp(){
  const u=document.getElementById('webappUrl').value.trim();
  if(!u){ alert('No hay URL para guardar.'); return; }
  try{ localStorage.setItem(LS_WEBAPP_KEY,u); setWebappStatus('ok','âœ“ URL guardada'); }catch(e){}
}
function onWebappInput(){
  const v=document.getElementById('webappUrl').value.trim();
  if(!v) setWebappStatus('warn','â€” Sin URL');
  else   setWebappStatus('warn','âš  URL modificada â€” no guardada');
}
function setWebappStatus(tipo,msg){
  const el=document.getElementById('webappStatus');
  el.textContent=msg; el.className=`webapp-status ${tipo}`;
}
async function testWebapp(){
  const url=document.getElementById('webappUrl').value.trim();
  if(!url){ alert('IngresÃ¡ la URL primero.'); return; }
  setWebappStatus('warn','â³ Probando conexiÃ³n...');
  try{
    const r=await fetch(url);
    const j=await r.json();
    if(j.status==='activo'||j.hojas) setWebappStatus('ok','âœ“ ConexiÃ³n OK â€” Web App activa');
    else setWebappStatus('err','âš  Respuesta inesperada: '+JSON.stringify(j));
  }catch(e){
    setWebappStatus('err','âœ— Error: '+e.message);
  }
}
function getWebappUrl(){
  const u=(document.getElementById('webappUrl').value||'').trim();
  if(!u){ alert('ConfigurÃ¡ la URL de Google Sheets Web App primero.'); return null; }
  return u;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetUI(){
  document.getElementById('progressWrap').classList.remove('visible');
  document.getElementById('resultOk').classList.remove('visible');
  document.getElementById('logBox').innerHTML='';
  setProgress(0);
}
function log(msg,tipo='info'){
  const box=document.getElementById('logBox');
  const line=document.createElement('div');
  line.className=`log-line ${tipo}`;
  const ts=new Date().toLocaleTimeString('es-AR');
  line.textContent=`[${ts}] ${msg}`;
  box.appendChild(line);
  box.scrollTop=box.scrollHeight;
}
function setProgress(pct){ document.getElementById('progressFill').style.width=pct+'%'; }
function showResult(msg){ const r=document.getElementById('resultOk'); r.textContent=msg; r.classList.add('visible'); }
function getToken(){
  const t=document.getElementById('bearerInput').value.trim();
  if(!t){ alert('IngresÃ¡ el Bearer Token primero.'); return null; }
  return t;
}
function setBtns(disabled){
  ['btnExcel','btnExcelSheets','btnCsv','btnCsvSheets'].forEach(id=>{
    const b=document.getElementById(id); if(b) b.disabled=disabled;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH CON RETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doFetch(url,token,asBlob=false,attempt=1){
  const res=await fetch(url,{headers:{Authorization:'Bearer '+token}});
  if(res.status===401) throw new Error('401 â€” Token invÃ¡lido o expirado');
  if(!res.ok){
    if(attempt<3&&res.status>=500){
      await new Promise(r=>setTimeout(r,1000*attempt*2));
      return doFetch(url,token,asBlob,attempt+1);
    }
    throw new Error('HTTP '+res.status);
  }
  return asBlob?await res.blob():await res.text();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLA CON CONCURRENCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runQueue(items,worker,concurrency=3){
  let idx=0; const running=new Set();
  async function next(){
    if(cancelFlag||idx>=items.length) return;
    const task=items[idx++];
    const p=(async()=>await worker(task))().finally(()=>running.delete(p));
    running.add(p);
    if(running.size<concurrency) next();
  }
  for(let i=0;i<Math.min(concurrency,items.length);i++) next();
  while(running.size){ await Promise.race([...running]); if(idx<items.length&&!cancelFlag) next(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENVIAR A GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function enviarASheets(sheetKey, headers, rows){
  const webappUrl=getWebappUrl(); if(!webappUrl) return false;
  log(`â¬† Enviando ${rows.length} filas a Sheets â†’ hoja "${sheetKey}"...`,'info');
  const res=await fetch(webappUrl,{
    method:'POST',
    headers:{'Content-Type':'text/plain'},  // evita preflight CORS
    body:JSON.stringify({sheetKey,headers,rows})
  });
  const json=await res.json();
  if(json.error) throw new Error(json.error);
  log(`âœ“ Sheets actualizado: "${json.hoja}" â€” ${json.filas} filas`,'ok');
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL 0 â€” COMPROBANTES EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cancelarExcel(){ cancelFlag=true; log('Cancelado por el usuario.','err'); }

async function iniciarDescargaExcel(modoSheets){
  const token=getToken(); if(!token) return;
  if(modoSheets&&!getWebappUrl()) return;
  if(selExcel.size===0){ alert('SeleccionÃ¡ al menos una Obra Social.'); return; }
  const from=document.getElementById('dateFrom').value;
  const to=document.getElementById('dateTo').value;
  if(!from||!to){ alert('CompletÃ¡ las fechas.'); return; }

  setBtns(true);
  document.getElementById('cancelExcel').classList.add('visible');
  document.getElementById('progressWrap').classList.add('visible');
  document.getElementById('logBox').innerHTML='';
  document.getElementById('resultOk').classList.remove('visible');
  setProgress(0);
  cancelFlag=false;

  const fromISO=`${from}T00:00:00.000Z`;
  const toISO=`${to}T23:59:59.999Z`;
  const selArr=[...selExcel].sort();
  const total=selArr.length;
  let allRows=[],headers=null,ok=0,errors=[];

  for(let idx=0;idx<selArr.length;idx++){
    if(cancelFlag) break;
    const os=OBRAS[selArr[idx]];
    log(`Descargando ${os.nombre}...`,'info');
    try{
      const url=`${os.base}/api/Comprobantes/Excel/?creadoFrom=${fromISO}&creadoTo=${toISO}&gLiquidacionAreaId=${G_LIQ_AREA_ID}&pageNumber=0&pageSize=99999`;
      const blob=await doFetch(url,token,true);
      const ab=await blob.arrayBuffer();
      const wb=XLSX.read(new Uint8Array(ab),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      if(data.length<2){ log(`âš  ${os.nombre} â€” Sin datos`,'info'); ok++; }
      else{
        if(!headers) headers=['Obra Social',...data[0]];
        const filas=data.slice(1).map(r=>[os.nombre,...r]);
        allRows=allRows.concat(filas);
        ok++;
        log(`âœ“ ${os.nombre} â€” ${filas.length} filas`,'ok');
      }
    }catch(e){
      errors.push(os.nombre);
      log(`âœ— ${os.nombre} â€” ${e.message}`,'err');
    }
    setProgress(Math.round(((idx+1)/total)*100));
  }

  if(ok>0&&headers){
    if(modoSheets){
      // Convertir valores a strings simples para evitar problemas de serializaciÃ³n
      const rowsStr=allRows.map(r=>r.map(c=>c===null||c===undefined?'':String(c)));
      try{
        await enviarASheets('COMPROBANTES SUBIDOS',headers.map(String),rowsStr);
        showResult(`âœ“ Google Sheets actualizado â€” ${allRows.length} filas Â· ${ok}/${total} obras sociales`+(errors.length?` Â· Errores: ${errors.join(', ')}`:''));
      }catch(e){
        log(`âœ— Error enviando a Sheets: ${e.message}`,'err');
      }
    } else {
      const ws=XLSX.utils.aoa_to_sheet([headers,...allRows]);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Comprobantes');
      const fromStr=from.replace(/-/g,'');
      const toStr=to.replace(/-/g,'');
      const fname=`Comprobantes_Area4_${fromStr}-${toStr}.xlsx`;
      XLSX.writeFile(wb,fname);
      showResult(`âœ“ ${fname} Â· ${allRows.length} filas Â· ${ok}/${total} obras`+(errors.length?` Â· Errores: ${errors.join(', ')}`:''));
      log(`Archivo generado: ${fname}`,'ok');
    }
  } else if(!cancelFlag){
    log('Sin datos. VerificÃ¡ token y CORS.','err');
  }

  setBtns(false);
  document.getElementById('cancelExcel').classList.remove('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL 1 â€” PEDIDOS CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cancelarCsv(){ cancelFlag=true; log('Cancelado por el usuario.','err'); }

function getPeriodos(){
  const tzNow=new Date(new Date().toLocaleString('en-US',{timeZone:'America/Argentina/Tucuman'}));
  const curY=tzNow.getFullYear(), curM=tzNow.getMonth()+1;
  const periodos=[];
  for(const year of [...selYears].sort()){
    const last=year<curY?12:curM-1;
    for(let m=1;m<=last;m++) periodos.push(`${year}${String(m).padStart(2,'0')}`);
  }
  return periodos;
}

function tipoToParams(tipo){
  return {aceptados:'hasDevok=true',rechazados:'hasDevok=false&hasError=true',noaceptados:'hasDevok=false&hasError=false'}[tipo];
}

function tzStamp(){
  const tz=new Date(new Date().toLocaleString('en-US',{timeZone:'America/Argentina/Tucuman'}));
  const p=n=>String(n).padStart(2,'0');
  return `${tz.getFullYear()}${p(tz.getMonth()+1)}${p(tz.getDate())}-${p(tz.getHours())}${p(tz.getMinutes())}`;
}

function downloadCsv(content,filename){
  const blob=new Blob(['\ufeff'+content],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}

async function iniciarDescargaCsv(modoSheets){
  const token=getToken(); if(!token) return;
  if(modoSheets&&!getWebappUrl()) return;
  if(selCsv.size===0){ alert('SeleccionÃ¡ al menos una Obra Social.'); return; }
  if(selYears.size===0){ alert('SeleccionÃ¡ al menos un aÃ±o.'); return; }

  const periodos=getPeriodos();
  if(periodos.length===0){ alert('No hay perÃ­odos cerrados para los aÃ±os seleccionados.'); return; }

  const tipo=document.getElementById('tipoSelect').value;
  const prueba=document.getElementById('modoPrueba').checked;
  const obras_use=prueba?[OBRAS[[...selCsv][0]]]:[...selCsv].sort().map(i=>OBRAS[i]);
  const periodos_use=prueba?[periodos[0]]:periodos;
  const targets=[];
  for(const o of obras_use) for(const p of periodos_use) targets.push({obra:o,periodo:p});

  setBtns(true);
  document.getElementById('cancelCsv').classList.add('visible');
  document.getElementById('progressWrap').classList.add('visible');
  document.getElementById('logBox').innerHTML='';
  document.getElementById('resultOk').classList.remove('visible');
  setProgress(0);
  cancelFlag=false;

  // Recolectar datos: guardamos como arrays para poder enviar a Sheets
  const seen=new Set();
  let headerArr=null;   // array de columnas
  const rowsArr=[];     // array de arrays
  let done=0, errors=[];
  const total=targets.length;

  async function worker({obra,periodo}){
    if(cancelFlag) return;
    try{
      const qs=`${tipoToParams(tipo)}&pageNumber=0&pageSize=10`;
      const url=`${obra.base}/api/IntegracionEnvioFtp/csv?periodoSss=${periodo}&${qs}`;
      const csv=await doFetch(url,token,false);
      const lines=csv.split(/\r?\n/).filter(l=>l.trim()!=='');
      if(lines.length<2){ log(`âš  ${obra.nombre} ${periodo} â€” Sin datos`,'info'); return; }
      if(!headerArr) headerArr=['ObraSocial','TipoPedido',...lines[0].split(';')];
      for(let i=1;i<lines.length;i++){
        const key=`${obra.nombre}|${periodo}|${lines[i]}`;
        if(!seen.has(key)){
          seen.add(key);
          rowsArr.push([obra.nombre,tipo,...lines[i].split(';')]);
        }
      }
      log(`âœ“ ${obra.nombre} ${periodo} â€” ${lines.length-1} filas`,'ok');
    }catch(e){
      errors.push(`${obra.nombre} ${periodo}`);
      log(`âœ— ${obra.nombre} ${periodo} â€” ${e.message}`,'err');
    }finally{
      done++;
      setProgress(Math.round((done/total)*100));
    }
  }

  await runQueue(targets,worker,3);

  if(!headerArr||rowsArr.length===0){ if(!cancelFlag) log('Sin datos. VerificÃ¡ token y CORS.','err'); setBtns(false); document.getElementById('cancelCsv').classList.remove('visible'); return; }

  // Ordenar por perÃ­odo de prestaciÃ³n â†’ ObraSocial
  const periodoIdx=headerArr.findIndex(h=>h.trim().toLowerCase()==='integracionperiodoprestacion');
  rowsArr.sort((a,b)=>{
    const ap=periodoIdx>=0?a[periodoIdx]:a[2];
    const bp=periodoIdx>=0?b[periodoIdx]:b[2];
    if(ap!==bp) return String(ap).localeCompare(String(bp));
    return String(a[0]).localeCompare(String(b[0]));
  });

  if(modoSheets){
    try{
      await enviarASheets(tipo,headerArr,rowsArr.map(r=>r.map(c=>String(c??''))));
      const yearsStr=[...selYears].sort().join('-');
      showResult(`âœ“ Google Sheets actualizado â€” hoja "${tipo.toUpperCase()}" Â· ${rowsArr.length} filas Â· ${yearsStr}`+(errors.length?` Â· Errores: ${errors.length}`:''));
    }catch(e){
      log(`âœ— Error enviando a Sheets: ${e.message}`,'err');
    }
  } else {
    // Reconstruir CSV desde arrays
    const csvLines=[headerArr.join(';'),...rowsArr.map(r=>r.join(';'))];
    const yearsStr=[...selYears].sort().join('-');
    const fname=`pedidos_${tipo}_${yearsStr}_all_obras_${tzStamp()}.csv`;
    downloadCsv(csvLines.join('\r\n'),fname);
    showResult(`âœ“ ${fname} Â· ${rowsArr.length} filas`+(errors.length?` Â· Errores: ${errors.length}`:''));
    log(`Archivo generado: ${fname}`,'ok');
  }

  setBtns(false);
  document.getElementById('cancelCsv').classList.remove('visible');
}
</script>
</body>
</html>
